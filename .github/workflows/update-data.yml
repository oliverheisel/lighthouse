name: Update data
on:
  workflow_dispatch:
  schedule:
    - cron: "15 0 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download Overpass data
        run: |
          set -euo pipefail
          mkdir -p data
      
          wget -O data/lighthousedata.json \
            "https://www.overpass-api.de/api/interpreter?data=%0A%09%09%09%5Bout%3Ajson%5D%5Btimeout%3A300%5D%3B%0A%09%09%09(%0A%09%09%09%20%20node%5B%22seamark%3Alight%3Asequence%22%5D(-90%2C-180%2C90%2C180)%3B%0A%09%09%09%20%20node%5B%22seamark%3Alight%3A1%3Asequence%22%5D(-90%2C-180%2C90%2C180)%3B%0A%09%09%09%20%20way%5B%22seamark%3Alight%3Asequence%22%5D(-90%2C-180%2C90%2C180)%3B%0A%09%09%09%20%20way%5B%22seamark%3Alight%3A1%3Asequence%22%5D(-90%2C-180%2C90%2C180)%3B%0A%09%09%09)%3B%0A%09%09%09out%20body%3B%0A%09%09%09%3E%3B%0A%09%09%09out%20skel%20qt%3B%0A%09%09"
      
          # --- VALIDATION ---
          test -s data/lighthousedata.json
      
          FIRST_CHAR="$(head -c 1 data/lighthousedata.json)"
          if [ "$FIRST_CHAR" != "{" ]; then
            echo "Overpass returned non-JSON:"
            head -c 300 data/lighthousedata.json
            exit 1
          fi

      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow

      - name: Build parquet and site dataset
        run: |
          python server/scripts/build_dataset.py

      - name: Commit data
        run: |
          git config --global user.name "oliverheisel"
          git config --global user.email "oliver@heisel.one"
          git add data/lighthouses.parquet server/site/data.min.json.gz
          git commit -m "Update lighthouse dataset" || echo "No changes"
          git push
